---
layout: post
name: 'Scaling the Waku Protocol: A Performance Analysis with Wakurtosis'  
title: 'Scaling the Waku Protocol: A Performance Analysis with Wakurtosis'
date: 2023-08-08 12:00:00
authors: Daimakaimura
published: true
slug: wakurtosis-waku-scallability-simulations
categories: waku, wakurtosis
---

# Scaling the Waku Protocol: A Performance Analysis with Wakurtosis

## Introduction

[Waku](https://waku.org/) is a family of P2P protocols enabling private, metadata-resistant messaging for Web3 by providing censorship resistance, adaptability, modular design, and a shared service network. Waku is designed to enable communication between decentralized applications (dApps) in a peer-to-peer manner.  
It serves as an improvement and successor to Ethereum's Whisper protocol, offering better scalability and efficiency.

[Waku Relay](https://rfc.vac.dev/spec/11/), on the other hand, is a specific component or sub-protocol within the broader Waku framework.  
It is responsible for relaying messages between nodes in the Waku network, effectively serving as the message dissemination mechanism.  
While Waku encompasses a variety of functionalities and improvements for decentralized messaging, Waku Relay specifically focuses on the message propagation aspect within this larger system.

Finally, [Discv5 (Discovery v5)](https://github.com/ethereum/devp2p/blob/master/discv5/discv5.md) is a peer-to-peer networking protocol designed to facilitate node discovery and routing in Ethereum-based decentralized networks. It serves as an upgrade to earlier discovery protocols and is designed to be modular and extensible, allowing it to support various types of decentralized systems beyond just Ethereum.  
The protocol enables nodes to find each other and maintain a distributed hash table for efficient routing.

The scalability and performance of the Waku protocol are of critical importance. To explore these facets with high granularity across a wide range of scenarios, we turned to [Wakurtosis](https://github.com/vacp2p/wakurtosis), a bespoke simulation framework developed internally.  
By studying various network sizes, message rates, and peer discovery setups, we aimed to better understand the protocol's capabilities and limitations, and hence aspects that could benefit from further optimization.

## Understanding Wakurtosis  

Wakurtosis is a simulation framework which integrates [Docker](https://www.docker.com/) and [Kurtosis](https://www.kurtosis.com/) to create a simulation environment that allows highly granular, large-scale simulations with a variety of traffic and network patterns.
At the core of Wakurtosis is Kurtosis — an orchestration tool responsible for managing containers, known as services, within isolated environments called enclaves.  
These enclaves house virtual networks and their respective containers. In addition to this, several external modules developed in-house expand some of Kurtosis' limitations:

- Network Generation Module (Gennet): Initiates and configures networks for the simulation. It's highly modular, supporting the integration of multiple topologies, protocols, and node traits.

- Packet Injection Module (WLS): Allows for the insertion of custom data packets, thereby enabling varied traffic patterns and stress tests on the simulations.

- Analysis Module: Captures and provides insights into resource usage, network behaviors, and protocol interactions throughout the enclave.

### Data Collection  

Wakurtosis ensures the accuracy of its data by leveraging multiple sources for hardware metrics:

##### Cadvisor (a Google tool)

[Cadvisor](https://github.com/google/cadvisor) provides detailed metrics on resource usage and performance characteristics of Docker containers. Cadvisor monitors application containers at the individual level by directly interfacing with Docker's daemon API.
While Cadvisor offers real-time metrics, it primarily focuses on container-specific metrics, which may neglect broader system-level insights.  

##### Docker statistics

[Docker statistics](https://docs.docker.com/engine/reference/commandline/stats/) provides insights into Docker's overall performance and resource allocation.  
This native Docker tool captures statistics about running containers using Docker's stats API, collecting cumulative CPU, memory, network, and block I/O metrics.
Docker statistics offer a bird's-eye view of the system, which can sometimes miss the granularity of performance fluctuations inside individual containers, particularly when dealing with multiple processes per container.

##### Process-level monitoring

Process-level monitoring offers detailed insights by tracking operational traits of processes within containers.
This method employs deep inspection of individual processes running inside a container by accessing */proc* kernel files to gather real-time process statistics.  
Reading from the */proc* filesystem offers a direct window into kernel statistics, providing comprehensive metrics on each process within the containers.
However, while it offers granular insights, process-level monitoring can be more resource-intensive and might not always capture overarching system behavior.   

### Performance Metrics

Each simulation lasted 3 hours to reach a steady state.  

- Hardware Level Metrics: Emphasis on memory usage, CPU consumption, disk I/O, and network I/O.

- Topology Level Metrics: Focuses on the efficiency of message propagation across the network, including metrics like message injection, propagation times, and message loss.

### Scalability  

To overcome scalability challenges, Wakurtosis employs a multi-node approach, running several nodes within one container.
This method supports simulations with over 1,000 nodes on a single machine.  
However, this can introduce unforeseen network effects, potentially affecting some metrics. For instance, running several nodes per container can alter propagation times, as nodes grouped within the same container may exhibit different messaging behavior compared to a true node-to-node topology.
Additionally, employing a multi-node approach may result in losing node-level sampling granularity depending on the metrics infrastructure used, e.g. Cadvisor.
Nevertheless, Wakurtosis offers the flexibility to choose between this and a 1-to-1 simulation, catering to the specific needs of each test scenario. The results presented here are 1-to-1 simulations.  

## Examining the Waku Protocol

### Simulation Setup

To evaluate Waku under varied conditions, we conducted simulations across a range of network sizes, topologies, and message rates. Each simulation lasted 3 hours to reach a steady state.
The network sizes explored included 75, 150, 300, and 600 nodes. For Non-Discv5 simulations, we used static topologies with average node degrees of K=3, K=13, and K=50. In simulations with Discv5, we set the max_peers parameter to 12 and 50 to approximate similar average degrees.
To stress test message throughput, we simulated message rates of 1, 10, and 100 messages per second.
This combination of network sizes, topologies, message rates, and hardware configurations enabled us to comprehensively evaluate Waku's performance and scalability boundaries under diverse conditions.

#### Clarification on Non-Discv5 Scenarios:  

It's important to note that the Non-Discv5 scenarios presented in this study serve as a theoretical baseline for comparison and are not meant to represent real-world conditions.
In a live environment, some form of peer discovery mechanism would be necessary for the functioning of the network.
Mechanisms like 'rendezvous' would also introduce additional bandwidth costs.
Therefore, the intention behind including Non-Discv5 simulations is not to compare their performance directly with Discv5 but rather to establish a fundamental baseline against which the added complexities and scaling costs of employing a discovery mechanism like Discv5 can be better understood.  

### Results

To provide a clear visualization of bandwidth usage in all the cases we studied, we've presented the results as multipliers over the pure payload for both reception (Rx) and transmission (Tx) in two heatmaps:

![Bandwidth efficiencies multipliers over pure payloads in transmission](/static/img/wakurtosis_waku/waku_bandwidth_rx_efficiency.png)

![Bandwidth efficiencies multipliers over pure payloads in reception](/static/img/wakurtosis_waku/waku_bandwidth_tx_efficiency.png)  

Overall, despite certain scalability and stability challenges, Wakurtosis has proved effective in simulating a Waku network up to 600 nodes on a single machine.

#### Baseline  

Under baseline conditions --- static network with average degrees of K=3, K=13, and K=50 --- revealed good scalability and stability.

Memory usage grew from 14.9 MB to 22.85 MB as message rate increased from 1 to 100 Msg/s, showing nonlinear scaling. But network size increases from 75 to 600 nodes only caused modest 0-20% memory growth at 1 Msg/s.  

Bandwidth utilization exhibited minor fluctuations as the network size increased, and efficiency in bandwidth usage improved with an increase in the message rate.

Some inefficiencies were noted in larger networks, suggesting room for improvement, but overall Waku displayed very stable behavior in terms of memory and bandwidth usage.  

#### Discovery v5

Memory usage exhibits a similar nonlinear pattern in relation to message rates, with memory increasing 60-65% from 16.39 MB at 1 Msg/s to 26.99 MB at 100 Msg/s.

However, unlike in the baseline scenario, Discv5 appears to have more significant relative growth in memory consumption, around 20%, when expanding network size from 75 to 600 nodes at 1 Msg/s, from 16.39 MB to 20.09 MB.  

This indicates Discv5 may have higher costs for larger networks, likely due to the additional routing information that needs to be stored and maintained.

When examining the effects on bandwidth utilization, we see varying results.  
For reception rates, with lower message rates we observe that Discv5 consistently utilizes more bandwidth than the corresponding Non-Discv5 case. However, those differences become less pronounced with higher message rates.
For transmission rates, both cases show similar performance and both exhibit huge improvements in transmission efficiency at higher message loads.  

## Conclusion  

This study underscores the Waku protocol’s resilience and scalability across varied conditions but also highlights the limitations of Wakurtosis and the need for a more robust simulation infrastructure for demanding scenarios.
The protocol’s robustness, evidenced by the absence of message loss, good stability across network sizes and traffic loads, is a notable takeaway.
As expected, simulations with Discv5 generally lead to higher memory and bandwidth usage throughout the majority of scenarios.
Guided by these insights, our immediate priority is keeping studying Waku behaviour for greater scalability and performance, especially under larger network loads, high-traffic situations, and different protocol configurations.
Stay updated with our progress!