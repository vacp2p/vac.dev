&mdash;
layout: post
name: 'Scaling the Waku Protocol: A Performance Analysis with Wakurtosis'  
title: 'Scaling the Waku Protocol: A Performance Analysis with Wakurtosis'
date: 2023-08-08 12:00:00
authors: Daimakaimura
published: true
slug: wakurtosis-waku-scallability-simulations
categories: waku, wakurtosis
&mdash;

# Scaling the Waku Protocol: A Performance Analysis with Wakurtosis

## Introduction

[Waku](https://waku.org/) is a family of P2P protocols enabling private, metadata-resistant messaging for Web3 by providing censorship resistance, adaptability, modular design, and a shared service network. Waku is designed to enable communication between decentralized applications (dApps) in a peer-to-peer manner.  
It serves as an improvement and successor to Ethereum's Whisper protocol, offering better scalability and efficiency.

[Waku Relay](https://rfc.vac.dev/spec/11/), on the other hand, is the core component within the broader Waku framework.  
It is responsible for relaying messages between nodes in the Waku network, effectively serving as the message dissemination mechanism.  
While Waku encompasses a variety of functionalities and improvements for decentralized messaging, Waku Relay specifically focuses on the message propagation aspect within this larger system.

Finally, [Discv5 (Discovery v5)](https://github.com/ethereum/devp2p/blob/master/discv5/discv5.md) is a peer-to-peer networking protocol designed to facilitate node discovery decentralized networks. It serves as an upgrade to earlier discovery protocols and is designed to be modular and extensible, allowing it to support various types of decentralized systems beyond just Ethereum.  
The protocol enables nodes to find each other, maintaining a distributed hash table.

The scalability and performance of the Waku protocol are of critical importance. To explore these facets with high granularity across a wide range of scenarios, we turned to [Wakurtosis](https://github.com/vacp2p/wakurtosis), a bespoke simulation framework developed internally.  
By studying various network sizes, message rates, and peer discovery setups, we aimed to better understand the protocol's capabilities and limitations, and hence aspects that could benefit from further optimization.

## Understanding Wakurtosis  

Wakurtosis is a simulation framework which integrates [Docker](https://www.docker.com/) and [Kurtosis](https://www.kurtosis.com/) to create a simulation environment that allows highly granular, large-scale simulations with a variety of traffic and network patterns.
At the core of Wakurtosis is Kurtosis — an orchestration tool responsible for managing containers, known as services, within isolated environments called enclaves.  
These enclaves house virtual networks and their respective containers. In addition to this, several external modules developed in-house expand some of Kurtosis' limitations:

- Network Generation Module (Gennet): Initiates and configures networks for the simulation. It's highly modular, supporting the integration of multiple topologies, protocols, and node traits.

- Packet Injection Module (WLS): Allows for the insertion of custom data packets, thereby enabling varied traffic patterns and stress tests on the simulations.

- Analysis Module: Captures and provides insights into resource usage, network behaviors, and protocol interactions throughout the enclave.

### Data Collection  

Wakurtosis ensures the accuracy of its data by leveraging multiple sources for hardware metrics:

- ##### Cadvisor (a Google tool)
  [Cadvisor](https://github.com/google/cadvisor) provides detailed metrics on resource usage and performance characteristics of Docker containers. Cadvisor monitors application containers at the individual level by directly interfacing with Docker's daemon API.
While Cadvisor offers real-time metrics, it primarily focuses on container-specific metrics, which may neglect broader system-level insights.  

- ##### Docker statistics
  [Docker statistics](https://docs.docker.com/engine/reference/commandline/stats/) provides insights into Docker's overall performance and resource allocation.  
This native Docker tool captures statistics about running containers using Docker's stats API, collecting cumulative CPU, memory, network, and block I/O metrics.
Docker statistics offer a bird's-eye view of the system, which can sometimes miss the granularity of performance fluctuations inside individual containers, particularly when dealing with multiple processes per container.

- ##### Process-level monitoring
  Process-level monitoring offers detailed insights by tracking operational traits of processes within containers.
This method employs deep inspection of individual processes running inside a container by accessing */proc* kernel files to gather real-time process statistics.  
Reading from the */proc* filesystem offers a direct window into kernel statistics, providing comprehensive metrics on each process within the containers.
However, while it offers granular insights, process-level monitoring can be more resource-intensive and might not always capture overarching system behavior.   

### Performance Metrics

Each simulation lasted 3 hours to reach a steady state.  

- Hardware Level Metrics: Emphasis on memory usage, CPU consumption, disk I/O, and network I/O.

- Topology Level Metrics: Focuses on the efficiency of message propagation across the network, including metrics like message injection, propagation times, and message loss.

### Scalability  

To overcome scalability challenges, Wakurtosis employs a multi-node approach, running several nodes within one container.
This method supports simulations with over 1,000 nodes on a single machine.  
However, this can introduce unforeseen network effects, potentially affecting some metrics. For instance, running several nodes per container can alter propagation times, as nodes grouped within the same container may exhibit different messaging behavior compared to a true node-to-node topology.
Additionally, employing a multi-node approach may result in losing node-level sampling granularity depending on the metrics infrastructure used, e.g. Cadvisor.

Nevertheless, Wakurtosis offers the flexibility to choose between this and a 1-to-1 simulation, catering to the specific needs of each test scenario. The results presented here are 1-to-1 simulations.  

## Examining the Waku Protocol

### Simulation Setup

To evaluate Waku under varied conditions, we conducted simulations across a range of network sizes, topologies, and message rates. Each simulation lasted 3 hours to reach a steady state.

The network sizes explored included 75, 150, 300, and 600 nodes. For Non-Discv5 simulations, we used static topologies with average node degrees of K=50. In simulations with Discv5, we set the max_peers parameter to 50 to approximate similar average degrees.

To stress test message throughput, we simulated message rates of 1, and 10 messages per second. We initally run simulations up to a 100 msg/s but we found out the results were unreliable due to simulation hardware limitations and therefore decided not to include them in this analysis.

We also included simulations batches with no load &mdash; i.e. 0 Msg/s. &mdash; to provide a clearer picture of Waku's baseline resource demands and inherent overhead costs stemming from core protocol operations.

This combination of network sizes, topologies, message rates, and hardware configurations enabled us to comprehensively evaluate Waku's performance and scalability boundaries under diverse conditions.

#### Clarification on Non-Discv5 Scenarios:  

It's important to note that the Non-Discv5 scenarios presented in this study serve as a theoretical baseline for comparison and are not meant to represent real-world conditions.
In a live environment, some form of peer discovery mechanism would be necessary for the functioning of the network.
Mechanisms like ['rendezvous'](https://docs.libp2p.io/concepts/discovery-routing/rendezvous/) would also introduce additional bandwidth costs.

Therefore, the intention behind including Non-Discv5 simulations is not to compare their performance directly with Discv5 but rather to establish a fundamental baseline against which the added complexities and scaling costs of employing a discovery mechanism like Discv5 can be better understood.  

### Simulation Results

To provide a clear visualization of bandwidth usage in all the cases we studied, we've presented the results in two plots, one for the non-discovery case and a second one for the discovery case. Both plots are divided in two subplots, one for reception (Rx) and one for transmission (Tx):

![Bandwidth efficiencies over adjusted pure payloads (baseline)](/static/img/wakurtosis_waku/Baseline_Efficiency.png)

![Bandwidth efficiencies over adjusted pure payloads (Discv5)](/static/img/wakurtosis_waku/Discv5_Efficiency.png)  

In these plots, efficiency is determined by contrasting the actual bytes transmitted (or received) due to messages with the total bandwidth consumed. 

It's essential to highlight that for better accuracy, we consider the actual message counts that were successfully injected into the network since due to hardware limitations, we've observed that not all anticipated messages get injected, which can skew the interpretation of bandwidth usage. 

An efficiency value close to 0 indicates that a minimal fraction of the total bandwidth is dedicated to the actual messages, suggesting a significant overhead. Conversely, an efficiency value approaching 1 signifies that the bandwidth usage closely corresponds with the actual message sizes, indicating negligible overhead.

Overall, despite certain scalability and stability challenges, Wakurtosis has proved effective in simulating a Waku network up to 600 nodes on a single machine.

#### Without discovery mechanism (baseline)

Baseline simulation results (under no load or 0 msgs/s) displayed excellent scalability and stability in terms of memory usage and bandwidth overhead.

Memory costs were consistently low, around 20 MB across network sizes, and increased minimally under load or with larger networks.

Transmission bandwidth under no load remained stable around 300 MB with minimal growth from network scaling, driven primarily by higher message rates. While the baseline simulation maintained a higher transmission and reception efficiency, especially at higher node counts and message rates, Discv5's efficiency waned as the network size increased.

Reception bandwidth started very low, around 15 MB, and rose substantially but mostly with increased traffic volume rather than larger network size. Across both scenarios, an increase in message rates generally corresponded with increased efficiency. However, the baseline scenario was more resilient, retaining its efficiency better than Discv5 under higher traffic.

Overall, the baseline simulations displayed efficient baseline overhead and scaling for memory, transmission, and reception as message rates grew or network size expanded.

#### With discovery mechanism (Discv5)

As expected, simulations with Discv5 showed poorer scalability and stability compared to the Non-Discv5 baseline.

Under no load (0 msgs/s), the memory overhead was consistently higher starting around 20 MB and increased substantially under load and with larger network sizes. Transmission bandwidth was also higher around 400 MB, though growth was driven primarily by message rate.

Reception bandwidth under no load saw the largest disparity, with Discv5 baseline around 100 MB and rising sharply under load and doubling with larger networks. The Discv5 mechanism struggled particularly in terms of reception efficiency as the node count increased, indicating potential challenges in scalability.

In summary, Discv5 exhibited notably higher baseline costs for memory, transmission, and especially reception bandwidth under no load. Growth under load was comparable for transmission but scaling with larger network size caused greater reception increases.

## Conclusion  

This study underscores the Waku protocol’s resilience and scalability across varied conditions but also highlights the limitations of Wakurtosis and the need for a more robust simulation infrastructure for demanding scenarios.
The protocol’s robustness, evidenced by the absence of message loss, good stability across network sizes and traffic loads, is a notable takeaway.
As expected, simulations with Discv5 generally lead to higher resource usage throughout the majority of scenarios, with reception bandwidth seeing the largest overhead and poorest scaling &mdash; nearly doubling baseline costs and growing substantially with larger network sizes.

Guided by these insights, our immediate priority is keeping studying Waku behaviour for greater scalability and performance, especially under larger network loads, high-traffic situations, and different protocol configurations.

Stay updated with our progress! 