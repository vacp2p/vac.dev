---
title: 'Fiat-Shamir'
date: 2024-07-01 12:00:00
authors: marvin
published: true
slug: Fiat-Shaimr
categories: research


toc_min_heading_level: 2
toc_max_heading_level: 5
---

Discussion on the conversion of interactive protocols to noninteractive protocols.
<!--truncate-->

## Blog - Fiat-Shamir Heuristics

Interactive protocols is a class of protocols that consist of two parties: the Prover and the Verifier.
The Prover tries to convince the Verifier of a given claim.
For example, the Prover may need to convince the Verifier that she owns a specific UTXO.
In many instances, there is information that the Prover does not wish to reveal to the Verifier.
For our example, it is critical that the Prover does not provide the Verifier with the private key associated to the UTXO.
In addition to the Prover's claim and secret data, there is additional data called public parameters that the claimed data is given in terms of.
The public parameters can be thought of as the basis for all similar claims.

In interactive protocols, the Prover and the Verifier are in active communication.
Specifically, the Prover and the Verifier exchange messages so that the Verifier can validate the Prover's claim.
This communication is not practical for many applications.
In decentralized systems, it is necessary that the Prover produces proofs on their own that any party can verify.
To achieve this, it is necessary for the Prover to generate the Verifier's messages in such a way that the Prover cannot manipulate the Verifier's messages for her benefit.
The [Fiat-Shamir heuristic](https://dl.acm.org/doi/10.5555/36664.36676) is used for this purpose.
In this document, we provide a discussion on the Fiat-Shamir heuristic, and known pitfalls of its application.

### Hash Functions
We begin by reviewing the properties of cryptographic hash functions.
A hash function $H$ is a special function that takes in an arbitrary binary string and outputs a bit string of a constant length.
Specifically,
$H : \{0,1\}^* \rightarrow \{0,1\}^n$.

Informally, a cryptographic hash function $H$ satisfies the following properties:
- **Succinct**: The hash $H({\bf{b}})$ can be efficiently computed for any binary string ${\bf{b}}$.
- **Preimage Resistance**: Let ${\bf{y}}$ be a binary string of length $n$.
    It should be 'impossible' to find some binary string ${\bf{x}}$ so that ${\bf{y}} = H({\bf{x}})$. 
- **Collision Resistance**: It should be 'impossible' to find two binary strings ${\bf{x}_1}$ and ${\bf{x}_2}$ so that $H({\bf{x}_1}) = H({\bf{x}_2}).$

Commonly used hash functions include SHA256, Keccak, and Poseidon.

### Fiat-Shamir heuristic (TODO: RETURN HERE)
Fiat-Shamir heuristic is a technique used to convert an interactive protocol to a noninteractive protocol.
This is done by replacing the Verifier's messages in the interactive protocol with hash values.

Specifically, given a hash function $H$.
The Fiat-Shamir heuristic for the interactive protocol $\Pi$ by $H$ consists of the following algorithms:
- $\tr \leftarrow \prove(\pp,x;w)$:
    The Prover generates her commitments and responses as she would have in $\Pi$.
    Additionally, she simulates any of the Verifier's challenges by evaluating $H$ on the concatenation of all of the public values  (including public parameters $\pp$) up to the current challenges.
- $b \in \{\acc,\rej\} \leftarrow \verify(\pp,x,\tr)$: 
    If the transcript $\tr$ is an accepting transcript for the protocol $\Pi$ and each challenge is generated appropriately by the hash $H$, then the algorithm outputs $\acc$.
    Otherwise, the algorithm outputs $\rej$.


TODO: Elaborate on the importance of using hashes

In the case of $\Sigma$-protocols,
Bernhard et al. \cite{pitfalls_FS} refer to
Definition \ref{defn:fs} as the strong Fiat-Shamir transformation. The weak version does not include the public parameters and the statement in the hash evaluation. Bernhard et al. provide a discussion of the insecurities that arise from use of the weak Fiat-Shamir transformation. 
The following example illustrates the necessity of the inclusion of the public parameters and statement.

### Improper Use of Fiat-Shamir?

A subtle but serious issue that can occur in the application of the Fiat-Shamir heuristic has been a point of discussion for the past few years.
Auditors from [Trail of Bits](https://www.trailofbits.com/) and [OpenZepellin](https://www.openzeppelin.com/) have released blogs (TODO-CITATIONS) and papers (TODO-CITATIONS) describing specific vunerabilities in zero-knowledge papers and repositories associated to improper application of the Fiat-Shamir heuristics.
In a theoretical sense, a system is vunerable to a malicious Prover when the Verifier's challenges are simulated using weak Fiat-Shamir.
In a much more understandable sense, the challenges are generated without fixing all of the values (especially the public parameters).

Trail of Bits coined this vunerability as **FROZEN Heart**.
Frozen comes from the phrase "FoRging Of ZEro kNoledge proofs",
and Fiat-Shamir is the "heart" of transforming an interactive protocol to non-interactive procotol.

#### Example 1 - The Schnorr Protocol
The Schnorr protocol is the simplest interactive protocol the vunerability of applying weak Fiat-Shamir.

TODO-add motivation for Schnorr protocol

|Prover| | Verifier|
|----|----|----|
|$t \in_R \mathbb{Z}_p$, $T := g^t$|    |    |
|    | $T \rightarrow$| |
|  |  | $c \in_R \mathbb{Z}_p$|
|  | $\leftarrow c$ |
| $z := t + xc$ | | |
| | $z \rightarrow$ | |
| | | output 1 provided $g^z == T X^c$|

TODO - more explanation

When the strong Fiat-Shamir heuristics is applied,
the challenge $c = Hash(g|X|T)$.
This choice of $c$ provides security since it should be 'impossible' to find collisions for the outputs of $Hash$.
Thus, $c$ fixes the group elements $g$, $X$ and $T$.

Note that the elements that would be neglected in applying weak Fiat-Shamir are $g$ and $X$.
Now, we examine a couple variations of applying weak Fiat-Shamir.

#### Example 1 - Approach 1
In this first approach, we will omit the generator $g \in \mathbb{G}$ from the computation for the challenge $c$.
That is, $c = Hash(X,T)$.

A malicious Prover completes the transcript for the Schnorr protocol by selecting any $z \in_R \mathbb{Z}_p$.
At this point, the generator $g$ has not been selected.
But, the malicious Prover needs the transcript $(T,c,z)$ to satisfy $g^z == TX^c$.
Hence, the malicious Prover takes $g = (TX^c)^{z^{-1}}.$

#### Example 1 - Approach 2
In our second approach, we omit the public address $X \in \mathbb{G}$ from the computation for the challenge $c$.
That is, $c = Hash(g,T)$.

As with the previous example, the malicious Prover takes a Schnorr transcript $(T,c,z)$ where $z \in_R \mathbb{Z}_p$.
It is necessary for the malicious Prover to find a value $X$ so that $g^z == TX^c$.
This can be acheived by taking $X = (g^z T^{-1})^{c^{-1}}$.

#### Example 2 - 
TODO

The transformation of 

Sigmabus mentions incorrect usage
What about one of the other 
Last challenge attack from Open-Zip

### References
- [How to Prove Yourself: Practical Solutions to Identification and Signature Problems](https://dl.acm.org/doi/10.5555/36664.36676)
- [Frozen Heart - Part 1](https://blog.trailofbits.com/2022/04/13/part-1-coordinated-disclosure-of-vulnerabilities-affecting-girault-bulletproofs-and-plonk/)
- [Frozen Heart - Part 2](https://blog.trailofbits.com/2022/04/14/the-frozen-heart-vulnerability-in-giraults-proof-of-knowledge/)
- [Frozen Heart - Part 3](https://blog.trailofbits.com/2022/04/15/the-frozen-heart-vulnerability-in-bulletproofs/)
- [Frozen Heart - Part 4](https://blog.trailofbits.com/2022/04/18/the-frozen-heart-vulnerability-in-plonk/)
- [Weak Fiat-Shamir Attacks on Modern Proof Systems](https://eprint.iacr.org/2023/691)
- [The Last Challenge Attack Blog](https://blog.openzeppelin.com/the-last-challenge-attack)
- [The Last Challenge Attack](https://eprint.iacr.org/2024/398)
- [Efficient Identification and Signatures for Smart Cards](https://link.springer.com/chapter/10.1007/0-387-34805-0_22)
- [Wallet Databases with Observers](https://link.springer.com/content/pdf/10.1007/3-540-48071-4_7.pdf)
- [How not to Prove Yourself: Pitfalls of the Fiat-Shamir Heuristic and Applications to Helios](https://eprint.iacr.org/2016/771.pdf)