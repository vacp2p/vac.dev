"use strict";(self.webpackChunkvac_dev=self.webpackChunkvac_dev||[]).push([[819],{30780:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>n,metadata:()=>r,toc:()=>c});var i=a(87462),s=(a(67294),a(3905));const n={layout:"post",name:"Fixing Whisper with Waku",title:"Fixing Whisper with Waku",date:new Date("2019-12-03T12:00:00.000Z"),authors:"oskarth",published:!0,slug:"fixing-whisper-with-waku",categories:"research",image:"/img/whisper_scalability.png",discuss:"https://forum.vac.dev/t/discussion-fixing-whisper-with-waku/27"},o=void 0,r={permalink:"/rlog/fixing-whisper-with-waku",source:"@site/rlog/2019-12-03-fixing-whisper-with-waku.mdx",title:"Fixing Whisper with Waku",description:"A research log. Why Whisper doesn't scale and how to fix it.",date:"2019-12-03T12:00:00.000Z",formattedDate:"December 3, 2019",tags:[],readingTime:9.995,hasTruncateMarker:!0,authors:[{name:"Oskar",twitter:"oskarth",github:"oskarth",key:"oskarth"}],frontMatter:{layout:"post",name:"Fixing Whisper with Waku",title:"Fixing Whisper with Waku",date:"2019-12-03T12:00:00.000Z",authors:"oskarth",published:!0,slug:"fixing-whisper-with-waku",categories:"research",image:"/img/whisper_scalability.png",discuss:"https://forum.vac.dev/t/discussion-fixing-whisper-with-waku/27"},prevItem:{title:"DNS Based Discovery",permalink:"/rlog/dns-based-discovery"},nextItem:{title:"Feasibility Study: Semaphore rate limiting through zkSNARKs",permalink:"/rlog/feasibility-semaphore-rate-limiting-zksnarks"}},l={authorsImageUrls:[void 0]},c=[{value:"Introduction",id:"introduction",level:2},{value:"Whisper theoretical scalability model",id:"whisper-theoretical-scalability-model",level:2},{value:"Caveats",id:"caveats",level:3},{value:"Goals",id:"goals",level:3},{value:"Model",id:"model",level:3},{value:"Takeaways",id:"takeaways",level:3},{value:"Introducing Waku",id:"introducing-waku",level:2},{value:"Motivation for a new protocol",id:"motivation-for-a-new-protocol",level:3},{value:"Briefly on Waku mode",id:"briefly-on-waku-mode",level:3},{value:"Progress so far",id:"progress-so-far",level:3}],p={toc:c};function d(e){let{components:t,...n}=e;return(0,s.kt)("wrapper",(0,i.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("p",null,"A research log. Why Whisper doesn't scale and how to fix it."),(0,s.kt)("p",null,"This post will introduce Waku. Waku is a fork of Whisper that attempts to\naddresses some of Whisper's shortcomings in an iterative fashion. We will also\nintroduce a theoretical scaling model for Whisper that shows why it doesn't\nscale, and what can be done about it."),(0,s.kt)("h2",{id:"introduction"},"Introduction"),(0,s.kt)("p",null,"Whisper is a gossip-based communication protocol or an ephemeral key-value store\ndepending on which way you look at it. Historically speaking, it is the\nmessaging pilllar of ",(0,s.kt)("a",{parentName:"p",href:"http://gavwood.com/dappsweb3.html"},"Web3"),", together with\nEthereum for consensus and Swarm for storage."),(0,s.kt)("p",null,"Whisper, being a somewhat esoteric protocol and with some fundamental issues,\nhasn't seen a lot of usage. However, applications such as Status are using it,\nand have been making minor ad hoc modifications to it to make it run on mobile\ndevices."),(0,s.kt)("p",null,"What are these fundamental issues? In short:"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"scalability, most immediately when it comes to bandwidth usage"),(0,s.kt)("li",{parentName:"ol"},"spam-resistance, proof of work is a poor mechanism for heterogeneous nodes"),(0,s.kt)("li",{parentName:"ol"},"no incentivized infrastructure, leading to centralized choke points"),(0,s.kt)("li",{parentName:"ol"},"lack of formal and unambiguous specification makes it hard to analyze and implement"),(0,s.kt)("li",{parentName:"ol"},"running over devp2p, which limits where it can run and how")),(0,s.kt)("p",null,"In this post, we'll focus on the first problem, which is scalability through bandwidth usage."),(0,s.kt)("h2",{id:"whisper-theoretical-scalability-model"},"Whisper theoretical scalability model"),(0,s.kt)("p",null,(0,s.kt)("em",{parentName:"p"},"(Feel free to skip this section if you want to get right to the results).")),(0,s.kt)("p",null,"There's widespread implicit knowledge that Whisper \"doesn't scale\", but it is less understood exactly why. This theoretical model attempts to encode some characteristics of it. Specifically for use case such as one by Status (see ",(0,s.kt)("a",{parentName:"p",href:"https://specs.status.im/spec/3"},"Status Whisper usage\nspec"),")."),(0,s.kt)("h3",{id:"caveats"},"Caveats"),(0,s.kt)("p",null,"First, some caveats: this model likely contains bugs, has wrong assumptions, or completely misses certain dimensions. However, it acts as a form of existence proof for unscalability, with clear reasons."),(0,s.kt)("p",null,"If certain assumptions are wrong, then we can challenge them and reason about them in isolation. It doesn\u2019t mean things will definitely work as the model predicts, and that there aren\u2019t unknown unknowns."),(0,s.kt)("p",null,"The model also only deals with receiving bandwidth for end nodes, uses mostly static assumptions of averages, and doesn\u2019t deal with spam resistance, privacy guarantees, accounting, intermediate node or network wide failures."),(0,s.kt)("h3",{id:"goals"},"Goals"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"Ensure network scales by being user or usage bound, as opposed to bandwidth growing in proportion to network size."),(0,s.kt)("li",{parentName:"ol"},"Staying with in a reasonable bandwidth limit for limited data plans."),(0,s.kt)("li",{parentName:"ol"},"Do the above without materially impacting existing nodes.")),(0,s.kt)("p",null,"It proceeds through various case with clear assumptions behind them, starting from the most naive assumptions. It shows results for 100 users, 10k users and 1m users."),(0,s.kt)("h3",{id:"model"},"Model"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre"},"Case 1. Only receiving messages meant for you [naive case]\n\nAssumptions:\n- A1. Envelope size (static): 1024kb\n- A2. Envelopes / message (static): 10\n- A3. Received messages / day (static): 100\n- A4. Only receiving messages meant for you.\n\nFor 100 users, receiving bandwidth is 1000.0KB/day\nFor 10k users, receiving bandwidth is 1000.0KB/day\nFor  1m users, receiving bandwidth is 1000.0KB/day\n\n------------------------------------------------------------\n\nCase 2. Receiving messages for everyone [naive case]\n\nAssumptions:\n- A1. Envelope size (static): 1024kb\n- A2. Envelopes / message (static): 10\n- A3. Received messages / day (static): 100\n- A5. Received messages for everyone.\n\nFor 100 users, receiving bandwidth is   97.7MB/day\nFor 10k users, receiving bandwidth is    9.5GB/day\nFor  1m users, receiving bandwidth is  953.7GB/day\n\n------------------------------------------------------------\n\nCase 3. All private messages go over one discovery topic [naive case]\n\nAssumptions:\n- A1. Envelope size (static): 1024kb\n- A2. Envelopes / message (static): 10\n- A3. Received messages / day (static): 100\n- A6. Proportion of private messages (static): 0.5\n- A7. Public messages only received by relevant recipients (static).\n- A8. All private messages are received by everyone (same topic) (static).\n\nFor 100 users, receiving bandwidth is   49.3MB/day\nFor 10k users, receiving bandwidth is    4.8GB/day\nFor  1m users, receiving bandwidth is  476.8GB/day\n\n------------------------------------------------------------\n\nCase 4. All private messages are partitioned into shards [naive case]\n\nAssumptions:\n- A1. Envelope size (static): 1024kb\n- A2. Envelopes / message (static): 10\n- A3. Received messages / day (static): 100\n- A6. Proportion of private messages (static): 0.5\n- A7. Public messages only received by relevant recipients (static).\n- A9. Private messages partitioned across partition shards (static), n=5000\n\nFor 100 users, receiving bandwidth is 1000.0KB/day\nFor 10k users, receiving bandwidth is    1.5MB/day\nFor  1m users, receiving bandwidth is   98.1MB/day\n\n------------------------------------------------------------\n\nCase 5. 4 + Bloom filter with false positive rate\n\nAssumptions:\n- A1. Envelope size (static): 1024kb\n- A2. Envelopes / message (static): 10\n- A3. Received messages / day (static): 100\n- A6. Proportion of private messages (static): 0.5\n- A7. Public messages only received by relevant recipients (static).\n- A9. Private messages partitioned across partition shards (static), n=5000\n- A10. Bloom filter size (m) (static): 512\n- A11. Bloom filter hash functions (k) (static): 3\n- A12. Bloom filter elements, i.e. topics, (n) (static): 100\n- A13. Bloom filter assuming optimal k choice (sensitive to m, n).\n- A14. Bloom filter false positive proportion of full traffic, p=0.1\n\nFor 100 users, receiving bandwidth is   10.7MB/day\nFor 10k users, receiving bandwidth is  978.0MB/day\nFor  1m users, receiving bandwidth is   95.5GB/day\n\nNOTE: Traffic extremely sensitive to bloom false positives\nThis completely dominates network traffic at scale.\nWith p=1% we get 10k users ~100MB/day and 1m users ~10gb/day)\n\n------------------------------------------------------------\n\nCase 6. Case 5 + Benign duplicate receives\n\nAssumptions:\n- A1. Envelope size (static): 1024kb\n- A2. Envelopes / message (static): 10\n- A3. Received messages / day (static): 100\n- A6. Proportion of private messages (static): 0.5\n- A7. Public messages only received by relevant recipients (static).\n- A9. Private messages partitioned across partition shards (static), n=5000\n- A10. Bloom filter size (m) (static): 512\n- A11. Bloom filter hash functions (k) (static): 3\n- A12. Bloom filter elements, i.e. topics, (n) (static): 100\n- A13. Bloom filter assuming optimal k choice (sensitive to m, n).\n- A14. Bloom filter false positive proportion of full traffic, p=0.1\n- A15. Benign duplicate receives factor (static): 2\n- A16. No bad envelopes, bad PoW, expired, etc (static).\n\nFor 100 users, receiving bandwidth is   21.5MB/day\nFor 10k users, receiving bandwidth is    1.9GB/day\nFor  1m users, receiving bandwidth is  190.9GB/day\n\n------------------------------------------------------------\n\nCase 7. 6 + Mailserver under good conditions; small bloom fp; mostly offline\n\nAssumptions:\n- A1. Envelope size (static): 1024kb\n- A2. Envelopes / message (static): 10\n- A3. Received messages / day (static): 100\n- A6. Proportion of private messages (static): 0.5\n- A7. Public messages only received by relevant recipients (static).\n- A9. Private messages partitioned across partition shards (static), n=5000\n- A10. Bloom filter size (m) (static): 512\n- A11. Bloom filter hash functions (k) (static): 3\n- A12. Bloom filter elements, i.e. topics, (n) (static): 100\n- A13. Bloom filter assuming optimal k choice (sensitive to m, n).\n- A14. Bloom filter false positive proportion of full traffic, p=0.1\n- A15. Benign duplicate receives factor (static): 2\n- A16. No bad envelopes, bad PoW, expired, etc (static).\n- A17. User is offline p% of the time (static) p=0.9\n- A18. No bad request, dup messages for mailservers; overlap perfect (static).\n- A19. Mailserver requests can change false positive rate to be p=0.01\n\nFor 100 users, receiving bandwidth is    3.9MB/day\nFor 10k users, receiving bandwidth is  284.8MB/day\nFor  1m users, receiving bandwidth is   27.8GB/day\n\n------------------------------------------------------------\n\nCase 8. No metadata protection w bloom filter; 1 node connected; static shard\n\nAka waku mode.\n\nNext step up is to either only use contact code, or shard more aggressively.\nNote that this requires change of other nodes behavior, not just local node.\n\nAssumptions:\n- A1. Envelope size (static): 1024kb\n- A2. Envelopes / message (static): 10\n- A3. Received messages / day (static): 100\n- A6. Proportion of private messages (static): 0.5\n- A7. Public messages only received by relevant recipients (static).\n- A9. Private messages partitioned across partition shards (static), n=5000\n\nFor 100 users, receiving bandwidth is 1000.0KB/day\nFor 10k users, receiving bandwidth is    1.5MB/day\nFor  1m users, receiving bandwidth is   98.1MB/day\n\n------------------------------------------------------------\n")),(0,s.kt)("p",null,"See ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/vacp2p/research/tree/master/whisper_scalability"},"source"),"\nfor more detail on the model and its assumptions."),(0,s.kt)("h3",{id:"takeaways"},"Takeaways"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"Whisper as it currently works doesn\u2019t scale, and we quickly run into unacceptable bandwidth usage."),(0,s.kt)("li",{parentName:"ol"},"There are a few factors of this, but largely it boils down to noisy topics usage and use of bloom filters. Duplicate (e.g. see ",(0,s.kt)("a",{parentName:"li",href:"https://our.status.im/whisper-pss-comparison/"},"Whisper vs PSS"),") and bad envelopes are also factors, but this depends a bit more on specific deployment configurations."),(0,s.kt)("li",{parentName:"ol"},"Waku mode (case 8) is an additional capability that doesn\u2019t require other nodes to change, for nodes that put a premium on performance."),(0,s.kt)("li",{parentName:"ol"},"The next bottleneck after this is the partitioned topics (app/network specific), which either needs to gracefully (and potentially quickly) grow, or an alternative way of consuming those messages needs to be deviced.")),(0,s.kt)("p",null,(0,s.kt)("img",{src:a(47144).Z,width:"1920",height:"934"})),(0,s.kt)("p",null,"The results are summarized in the graph above. Notice the log-log scale. The\ncolored backgrounds correspond to the following bandwidth usage:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Blue: <10mb/d (<~300mb/month)"),(0,s.kt)("li",{parentName:"ul"},"Green: <30mb/d (<~1gb/month)"),(0,s.kt)("li",{parentName:"ul"},"Yellow: <100mb/d (<~3gb/month)"),(0,s.kt)("li",{parentName:"ul"},"Red: >100mb/d (>3gb/month)")),(0,s.kt)("p",null,"These ranges are somewhat arbitrary, but are based on ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/status-im/status-react/issues/9081"},"user\nrequirements")," for users\non a limited data plan, with comparable usage for other messaging apps."),(0,s.kt)("h2",{id:"introducing-waku"},"Introducing Waku"),(0,s.kt)("h3",{id:"motivation-for-a-new-protocol"},"Motivation for a new protocol"),(0,s.kt)("p",null,"Apps such as Status will likely use something like Whisper for the forseeable\nfuture, and we want to enable them to use it with more users on mobile devices\nwithout bandwidth exploding with minimal changes."),(0,s.kt)("p",null,"Additionally, there's not a clear cut alternative that maps cleanly to the\ndesired use cases (p2p, multicast, privacy-preserving, open, etc)."),(0,s.kt)("p",null,"We are actively researching, developing and collaborating with more greenfield\napproaches. It is likely that Waku will either converge to those, or Waku will\nlay the groundwork (clear specs, common issues/components) necessary to make\nswitching to another protocol easier. In this project we want to emphasize\niterative work with results on the order of weeks."),(0,s.kt)("h3",{id:"briefly-on-waku-mode"},"Briefly on Waku mode"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Doesn\u2019t impact existing clients, it\u2019s just a separate node and capability."),(0,s.kt)("li",{parentName:"ul"},"Other nodes can still use Whisper as is, like a full node."),(0,s.kt)("li",{parentName:"ul"},"Sacrifices metadata protection and incurs higher connectivity/availability requirements for scalbility")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Requirements:")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"Exposes API to get messages from a set of list of topics (no bloom filter)"),(0,s.kt)("li",{parentName:"ul"},"Way of being identified as a Waku node (e.g. through version string)"),(0,s.kt)("li",{parentName:"ul"},"Option to statically encode this node in app, e.g. similar to custom bootnodes/mailserver"),(0,s.kt)("li",{parentName:"ul"},"Only node that needs to be connected to, possibly as Whisper relay / mailserver hybrid")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Provides:")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"likely provides scalability of up to 10k users and beyond"),(0,s.kt)("li",{parentName:"ul"},"with some enhancements to partition topic logic, can possibly scale up to 1m users (app/network specific)")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"Caveats:")),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"hasn\u2019t been tested in a large-scale simulation"),(0,s.kt)("li",{parentName:"ul"},"other network and intermediate node bottlenecks might become apparent (e.g. full bloom filter and private cluster capacity; can likely be dealt with in isolation using known techniques, e.g. load balancing) (deployment specific)")),(0,s.kt)("h3",{id:"progress-so-far"},"Progress so far"),(0,s.kt)("p",null,"In short, we have a ",(0,s.kt)("a",{parentName:"p",href:"https://rfc.vac.dev/waku/deprecated/5/waku0"},"Waku version 0 spec up")," as well as a ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/status-im/nim-eth/pull/120"},"PoC")," for backwards compatibility. In the coming weeks, we are going to solidify the specs, get a more fully featured PoC for ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/status-im/nim-eth/pull/114"},"Waku mode"),". See ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/vacp2p/pm/issues/5"},"rough roadmap"),", project board ","[link deprecated]"," and progress thread on the ",(0,s.kt)("a",{parentName:"p",href:"https://forum.vac.dev/t/waku-project-and-progress/24"},"Vac forum"),"."),(0,s.kt)("p",null,"The spec has been rewrittten for clarity, with ABNF grammar and less ambiguous language. The spec also incorporates several previously ",(0,s.kt)("a",{parentName:"p",href:"https://rfc.vac.dev/waku/standards/legacy/6/waku1/#additional-capabilities"},"ad hoc implemented features"),", such as light nodes and mailserver/client support. This has already caught a few incompatibilities between the ",(0,s.kt)("inlineCode",{parentName:"p"},"geth")," (Go), ",(0,s.kt)("inlineCode",{parentName:"p"},"status/whisper")," (Go) and ",(0,s.kt)("inlineCode",{parentName:"p"},"nim-eth")," (Nim) versions, specifically around light node usage and the handshake."),(0,s.kt)("p",null,"If you are interested in this effort, please check out ",(0,s.kt)("a",{parentName:"p",href:"https://forum.vac.dev/"},"our forum")," for questions, comments and proposals. We already have some discussion for better ",(0,s.kt)("a",{parentName:"p",href:"https://forum.vac.dev/t/stake-priority-based-queuing/26"},"spam protection")," (see ",(0,s.kt)("a",{parentName:"p",href:"https://vac.dev/feasibility-semaphore-rate-limiting-zksnarks"},"previous post")," for a more complex but privacy-preserving proposal), something that is likely going to be addressed in future versions of Waku, along with many other fixes and enhancement."))}d.isMDXComponent=!0},3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>m});var i=a(67294);function s(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function n(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,i)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?n(Object(a),!0).forEach((function(t){s(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):n(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function r(e,t){if(null==e)return{};var a,i,s=function(e,t){if(null==e)return{};var a,i,s={},n=Object.keys(e);for(i=0;i<n.length;i++)a=n[i],t.indexOf(a)>=0||(s[a]=e[a]);return s}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(i=0;i<n.length;i++)a=n[i],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(s[a]=e[a])}return s}var l=i.createContext({}),c=function(e){var t=i.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},p=function(e){var t=c(e.components);return i.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},u=i.forwardRef((function(e,t){var a=e.components,s=e.mdxType,n=e.originalType,l=e.parentName,p=r(e,["components","mdxType","originalType","parentName"]),u=c(a),m=s,h=u["".concat(l,".").concat(m)]||u[m]||d[m]||n;return a?i.createElement(h,o(o({ref:t},p),{},{components:a})):i.createElement(h,o({ref:t},p))}));function m(e,t){var a=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var n=a.length,o=new Array(n);o[0]=u;var r={};for(var l in t)hasOwnProperty.call(t,l)&&(r[l]=t[l]);r.originalType=e,r.mdxType="string"==typeof e?e:s,o[1]=r;for(var c=2;c<n;c++)o[c]=a[c];return i.createElement.apply(null,o)}return i.createElement.apply(null,a)}u.displayName="MDXCreateElement"},47144:(e,t,a)=>{a.d(t,{Z:()=>i});const i=a.p+"assets/images/whisper_scalability-4450d316341c4305ffc6f580a776fc2d.png"}}]);