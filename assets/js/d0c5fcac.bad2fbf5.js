"use strict";(self.webpackChunkvac_dev=self.webpackChunkvac_dev||[]).push([[9313],{37148:(t,e,a)=>{a.r(e),a.d(e,{assets:()=>o,contentTitle:()=>i,default:()=>d,frontMatter:()=>l,metadata:()=>s,toc:()=>p});var n=a(87462),r=(a(67294),a(3905));const l={layout:"post",name:"Waku Update",title:"Waku Update",date:new Date("2020-02-14T12:00:00.000Z"),authors:"oskarth",published:!0,slug:"waku-update",categories:"research",image:"/img/waku_infrastructure_sky.jpg",discuss:"https://forum.vac.dev/t/waku-update-where-are-we-at/34"},i=void 0,s={permalink:"/rlog/waku-update",source:"@site/rlog/2020-02-14-waku-update.mdx",title:"Waku Update",description:"A research log. What's the current state of Waku? How many users does it support? What are the bottlenecks? What's next?",date:"2020-02-14T12:00:00.000Z",formattedDate:"February 14, 2020",tags:[],readingTime:5.63,hasTruncateMarker:!0,authors:[{name:"Oskar",twitter:"oskarth",github:"oskarth",key:"oskarth"}],frontMatter:{layout:"post",name:"Waku Update",title:"Waku Update",date:"2020-02-14T12:00:00.000Z",authors:"oskarth",published:!0,slug:"waku-update",categories:"research",image:"/img/waku_infrastructure_sky.jpg",discuss:"https://forum.vac.dev/t/waku-update-where-are-we-at/34"},prevItem:{title:"From Kademlia to Discv5",permalink:"/rlog/kademlia-to-discv5"},nextItem:{title:"DNS Based Discovery",permalink:"/rlog/dns-based-discovery"}},o={authorsImageUrls:[void 0]},p=[{value:"Current state",id:"current-state",level:2},{value:"How many users does Waku support?",id:"how-many-users-does-waku-support",level:2},{value:"Simulation",id:"simulation",level:2},{value:"Difference between Waku and Whisper",id:"difference-between-waku-and-whisper",level:2},{value:"Next steps and future plans",id:"next-steps-and-future-plans",level:2},{value:"Acknowledgements",id:"acknowledgements",level:2}],u={toc:p};function d(t){let{components:e,...l}=t;return(0,r.kt)("wrapper",(0,n.Z)({},u,l,{components:e,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"A research log. What's the current state of Waku? How many users does it support? What are the bottlenecks? What's next?"),(0,r.kt)("p",null,"Waku is our fork of Whisper where we address the shortcomings of Whisper in an iterative manner. We've seen a in ",(0,r.kt)("a",{parentName:"p",href:"https://vac.dev/fixing-whisper-with-waku"},"previous post")," that Whisper doesn't scale, and why. In this post we'll talk about what the current state of Waku is, how many users it can support, and future plans."),(0,r.kt)("h2",{id:"current-state"},"Current state"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Specs:")),(0,r.kt)("p",null,"We released ",(0,r.kt)("a",{parentName:"p",href:"https://rfc.vac.dev/spec/6"},"Waku spec v0.3")," this week! You can see the full changelog ",(0,r.kt)("a",{parentName:"p",href:"https://rfc.vac.dev/spec/6/#changelog"},"here"),"."),(0,r.kt)("p",null,"The main change from 0.2 is making the handshake more flexible. This enables us to communicate topic interest immediately without ambiguity. We also did the following:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"added recommendation for DNS based discovery"),(0,r.kt)("li",{parentName:"ul"},"added an upgradability and compatibility policy"),(0,r.kt)("li",{parentName:"ul"},"cut the spec up into several components")),(0,r.kt)("p",null,"We cut the spec up in several components to make Vac as modular as possible. The components right now are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Waku (main spec), currently in ",(0,r.kt)("a",{parentName:"li",href:"https://rfc.vac.dev/spec/6"},"version 0.3.0")),(0,r.kt)("li",{parentName:"ul"},"Waku envelope data field, currently in ",(0,r.kt)("a",{parentName:"li",href:"https://rfc.vac.dev/spec/7"},"version 0.1.0")),(0,r.kt)("li",{parentName:"ul"},"Waku mailserver, currently in ",(0,r.kt)("a",{parentName:"li",href:"https://rfc.vac.dev/spec/8"},"version 0.2.0"))),(0,r.kt)("p",null,"We can probably factor these out further as the main spec is getting quite big, but this is good enough for now."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Clients:")),(0,r.kt)("p",null,"There are currently two clients that implement Waku v0.3, these are ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/status-im/nim-waku"},"Nimbus (Update: now nim-waku)")," in Nim and ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/status-im/status-go"},"status-go")," in Go."),(0,r.kt)("p",null,"For more details on what each client support and don't, you can follow the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/vacp2p/pm/issues/7"},"work in progress checklist"),"."),(0,r.kt)("p",null,"Work is currently in progress to integrate it into the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/status-im/status-react/pull/9949"},"Status core app"),". Waku is expected to be part of their upcoming 1.1 release (see ",(0,r.kt)("a",{parentName:"p",href:"https://trello.com/b/DkxQd1ww/status-app-roadmap"},"Status app roadmap (link deprecated)"),")."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Simulation:")),(0,r.kt)("p",null,"We have a ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/status-im/nim-waku/blob/master/waku/v1/node/quicksim.nim"},"simulation")," that verifies - or rather, fails to falsify - our ",(0,r.kt)("a",{parentName:"p",href:"https://vac.dev/fixing-whisper-with-waku"},"scalability model"),". More on the simulation and what it shows below."),(0,r.kt)("h2",{id:"how-many-users-does-waku-support"},"How many users does Waku support?"),(0,r.kt)("p",null,"This is our current understanding of how many users a network running Waku can support. Specifically in the context of the Status chat app, since that's the most immediate consumer of Waku. It should generalize fairly well to most deployments."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"tl;dr (for Status app):")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"beta: 100 DAU"),(0,r.kt)("li",{parentName:"ul"},"v1: 1k DAU"),(0,r.kt)("li",{parentName:"ul"},"v1.1 (waku only): 10k DAU (up to x10 with deployment hotfixes)"),(0,r.kt)("li",{parentName:"ul"},"v1.2 (waku+dns): 100k DAU (can optionally be folded into v1.1)")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"Assuming 10 concurrent users = 100 DAU. Estimate uncertainty increases for each order of magnitude until real-world data is observed.")),(0,r.kt)("p",null,"As far as we know right now, these are the bottlenecks we have:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Immediate bottleneck - Receive bandwidth for end user clients (aka \u2018Fixing Whisper with Waku\u2019)"),(0,r.kt)("li",{parentName:"ul"},"Very likely bottleneck - Nodes and cluster capacity (aka \u2018DNS based node discovery\u2019)"),(0,r.kt)("li",{parentName:"ul"},"Conjecture but not unlikely to appear- Full node traffic (aka \u2018the routing / partition problem\u2019)")),(0,r.kt)("p",null,"We've already seen the first bottleneck being discussed in the initial post. Dean wrote a post on ",(0,r.kt)("a",{parentName:"p",href:"https://vac.dev/dns-based-discovery"},"DNS based discovery")," which explains how we will address the likely second bottleneck. More on the third one in future posts."),(0,r.kt)("p",null,"For more details on these bottlenecks, see ",(0,r.kt)("a",{parentName:"p",href:"https://discuss.status.im/t/scalability-estimate-how-many-users-can-waku-and-the-status-app-support/1514"},"Scalability estimate: How many users can Waku and the Status app support?"),"."),(0,r.kt)("h2",{id:"simulation"},"Simulation"),(0,r.kt)("p",null,"The ultimate test is real-world usage. Until then, we have a simulation thanks to Kim De Mey from the Nimbus team!"),(0,r.kt)("p",null,(0,r.kt)("img",{src:a(81062).Z,width:"1131",height:"637"})),(0,r.kt)("p",null,"We have two network topologies, Star and full mesh. Both networks have 6 full nodes, one traditional light node with bloom filter, and one Waku light node."),(0,r.kt)("p",null,"One of the full nodes sends 1 envelope over 1 of the 100 topics that the two light nodes subscribe to. After that, it sends 10000 envelopes over random topics."),(0,r.kt)("p",null,"For light node, bloom filter is set to almost 10% false positive (bloom filter: n=100, k=3, m=512). It shows the number of valid and invalid envelopes received for the different nodes."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Star network:")),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Description"),(0,r.kt)("th",{parentName:"tr",align:null},"Peers"),(0,r.kt)("th",{parentName:"tr",align:null},"Valid"),(0,r.kt)("th",{parentName:"tr",align:null},"Invalid"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Master node"),(0,r.kt)("td",{parentName:"tr",align:null},"7"),(0,r.kt)("td",{parentName:"tr",align:null},"10001"),(0,r.kt)("td",{parentName:"tr",align:null},"0")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Full node 1"),(0,r.kt)("td",{parentName:"tr",align:null},"3"),(0,r.kt)("td",{parentName:"tr",align:null},"10001"),(0,r.kt)("td",{parentName:"tr",align:null},"0")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Full node 2"),(0,r.kt)("td",{parentName:"tr",align:null},"1"),(0,r.kt)("td",{parentName:"tr",align:null},"10001"),(0,r.kt)("td",{parentName:"tr",align:null},"0")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Full node 3"),(0,r.kt)("td",{parentName:"tr",align:null},"1"),(0,r.kt)("td",{parentName:"tr",align:null},"10001"),(0,r.kt)("td",{parentName:"tr",align:null},"0")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Full node 4"),(0,r.kt)("td",{parentName:"tr",align:null},"1"),(0,r.kt)("td",{parentName:"tr",align:null},"10001"),(0,r.kt)("td",{parentName:"tr",align:null},"0")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Full node 5"),(0,r.kt)("td",{parentName:"tr",align:null},"1"),(0,r.kt)("td",{parentName:"tr",align:null},"10001"),(0,r.kt)("td",{parentName:"tr",align:null},"0")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Light node"),(0,r.kt)("td",{parentName:"tr",align:null},"2"),(0,r.kt)("td",{parentName:"tr",align:null},"815"),(0,r.kt)("td",{parentName:"tr",align:null},"0")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Waku light node"),(0,r.kt)("td",{parentName:"tr",align:null},"2"),(0,r.kt)("td",{parentName:"tr",align:null},"1"),(0,r.kt)("td",{parentName:"tr",align:null},"0")))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Full mesh:")),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Description"),(0,r.kt)("th",{parentName:"tr",align:null},"Peers"),(0,r.kt)("th",{parentName:"tr",align:null},"Valid"),(0,r.kt)("th",{parentName:"tr",align:null},"Invalid"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Full node 0"),(0,r.kt)("td",{parentName:"tr",align:null},"7"),(0,r.kt)("td",{parentName:"tr",align:null},"10001"),(0,r.kt)("td",{parentName:"tr",align:null},"20676")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Full node 1"),(0,r.kt)("td",{parentName:"tr",align:null},"7"),(0,r.kt)("td",{parentName:"tr",align:null},"10001"),(0,r.kt)("td",{parentName:"tr",align:null},"9554")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Full node 2"),(0,r.kt)("td",{parentName:"tr",align:null},"5"),(0,r.kt)("td",{parentName:"tr",align:null},"10001"),(0,r.kt)("td",{parentName:"tr",align:null},"23304")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Full node 3"),(0,r.kt)("td",{parentName:"tr",align:null},"5"),(0,r.kt)("td",{parentName:"tr",align:null},"10001"),(0,r.kt)("td",{parentName:"tr",align:null},"11983")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Full node 4"),(0,r.kt)("td",{parentName:"tr",align:null},"5"),(0,r.kt)("td",{parentName:"tr",align:null},"10001"),(0,r.kt)("td",{parentName:"tr",align:null},"24425")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Full node 5"),(0,r.kt)("td",{parentName:"tr",align:null},"5"),(0,r.kt)("td",{parentName:"tr",align:null},"10001"),(0,r.kt)("td",{parentName:"tr",align:null},"23472")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Light node"),(0,r.kt)("td",{parentName:"tr",align:null},"2"),(0,r.kt)("td",{parentName:"tr",align:null},"803"),(0,r.kt)("td",{parentName:"tr",align:null},"803")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Waku light node"),(0,r.kt)("td",{parentName:"tr",align:null},"2"),(0,r.kt)("td",{parentName:"tr",align:null},"1"),(0,r.kt)("td",{parentName:"tr",align:null},"1")))),(0,r.kt)("p",null,"Things to note:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Whisper light node with ~10% false positive gets ~10% of total traffic"),(0,r.kt)("li",{parentName:"ul"},"Waku light node gets ~1000x less envelopes than Whisper light node"),(0,r.kt)("li",{parentName:"ul"},"Full mesh results in a lot more duplicate messages, expect for Waku light node")),(0,r.kt)("p",null,"Run the simulation yourself ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/status-im/nim-waku/blob/master/waku/v1/node/quicksim.nim"},"here"),". The parameters are configurable, and it is integrated with Prometheus and Grafana."),(0,r.kt)("h2",{id:"difference-between-waku-and-whisper"},"Difference between Waku and Whisper"),(0,r.kt)("p",null,"Summary of main differences between Waku v0 spec and Whisper v6, as described in ",(0,r.kt)("a",{parentName:"p",href:"https://eips.ethereum.org/EIPS/eip-627"},"EIP-627"),":"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Handshake/Status message not compatible with shh/6 nodes; specifying options as association list"),(0,r.kt)("li",{parentName:"ul"},"Include topic-interest in Status handshake"),(0,r.kt)("li",{parentName:"ul"},"Upgradability policy"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"topic-interest")," packet code"),(0,r.kt)("li",{parentName:"ul"},"RLPx subprotocol is changed from shh/6 to waku/0."),(0,r.kt)("li",{parentName:"ul"},"Light node capability is added."),(0,r.kt)("li",{parentName:"ul"},"Optional rate limiting is added."),(0,r.kt)("li",{parentName:"ul"},"Status packet has following additional parameters: light-node, confirmations-enabled and rate-limits"),(0,r.kt)("li",{parentName:"ul"},"Mail Server and Mail Client functionality is now part of the specification."),(0,r.kt)("li",{parentName:"ul"},"P2P Message packet contains a list of envelopes instead of a single envelope.")),(0,r.kt)("h2",{id:"next-steps-and-future-plans"},"Next steps and future plans"),(0,r.kt)("p",null,"Several challenges remain to make Waku a robust and suitable base\ncommunication protocol. Here we outline a few challenges that we are addressing and will continue to work on:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"scalability of the network"),(0,r.kt)("li",{parentName:"ul"},"incentived infrastructure and spam-resistance"),(0,r.kt)("li",{parentName:"ul"},"build with resource restricted devices in mind, including nodes being mostly offline")),(0,r.kt)("p",null,"For the third bottleneck, a likely candidate for fixing this is Kademlia routing. This is similar to what is done in ",(0,r.kt)("a",{parentName:"p",href:"https://www.ethswarm.org/"},"Swarm's")," PSS. We are in the early stages of experimenting with this over libp2p in ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/status-im/nim-libp2p"},"nim-libp2p"),". More on this in a future post!"),(0,r.kt)("h2",{id:"acknowledgements"},"Acknowledgements"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},'Image from "caged sky" by mh.xbhd.org is licensed under CC BY 2.0 (',(0,r.kt)("a",{parentName:"em",href:"https://ccsearch.creativecommons.org/photos/a9168311-78de-4cb7-a6ad-f92be8361d0e"},"https://ccsearch.creativecommons.org/photos/a9168311-78de-4cb7-a6ad-f92be8361d0e"),")")))}d.isMDXComponent=!0},3905:(t,e,a)=>{a.d(e,{Zo:()=>u,kt:()=>k});var n=a(67294);function r(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function l(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,n)}return a}function i(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?l(Object(a),!0).forEach((function(e){r(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}function s(t,e){if(null==t)return{};var a,n,r=function(t,e){if(null==t)return{};var a,n,r={},l=Object.keys(t);for(n=0;n<l.length;n++)a=l[n],e.indexOf(a)>=0||(r[a]=t[a]);return r}(t,e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(t);for(n=0;n<l.length;n++)a=l[n],e.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(t,a)&&(r[a]=t[a])}return r}var o=n.createContext({}),p=function(t){var e=n.useContext(o),a=e;return t&&(a="function"==typeof t?t(e):i(i({},e),t)),a},u=function(t){var e=p(t.components);return n.createElement(o.Provider,{value:e},t.children)},d={inlineCode:"code",wrapper:function(t){var e=t.children;return n.createElement(n.Fragment,{},e)}},m=n.forwardRef((function(t,e){var a=t.components,r=t.mdxType,l=t.originalType,o=t.parentName,u=s(t,["components","mdxType","originalType","parentName"]),m=p(a),k=r,h=m["".concat(o,".").concat(k)]||m[k]||d[k]||l;return a?n.createElement(h,i(i({ref:e},u),{},{components:a})):n.createElement(h,i({ref:e},u))}));function k(t,e){var a=arguments,r=e&&e.mdxType;if("string"==typeof t||r){var l=a.length,i=new Array(l);i[0]=m;var s={};for(var o in e)hasOwnProperty.call(e,o)&&(s[o]=e[o]);s.originalType=t,s.mdxType="string"==typeof t?t:r,i[1]=s;for(var p=2;p<l;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},81062:(t,e,a)=>{a.d(e,{Z:()=>n});const n=a.p+"assets/images/waku_simulation-3923bb91799b72a73608687149068b40.jpeg"}}]);